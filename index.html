<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legrand AV to Q360 Data Mapper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #173B69 0%, #2E5A88 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            padding: 40px;
            max-width: 700px;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .upload-section {
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #bdc3c7;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area:hover {
            border-color: #173B69;
            background-color: #f0f4f9;
        }
        
        .upload-area.dragover {
            border-color: #173B69;
            background-color: #e6eef7;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }
        
        .upload-text {
            color: #2c3e50;
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .upload-subtext {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        #fileInput {
            display: none;
        }
        
        .file-info {
            display: none;
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            color: #2e7d32;
        }
        
        .process-section {
            margin-bottom: 30px;
        }
        
        .process-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #173B69 0%, #2E5A88 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(23, 59, 105, 0.4);
        }
        
        .process-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(23, 59, 105, 0.5);
        }
        
        .process-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #173B69;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result-section {
            display: none;
        }

        .download-btn {
            width: 100%;
            padding: 16px 24px;
            background: #E5A02D;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.5);
        }
        
        .error-message {
            display: none;
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 15px;
            color: #c62828;
            margin-top: 15px;
        }
        
        .success-message {
            display: none;
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            color: #2e7d32;
            margin-top: 15px;
        }
        
        .stats {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Legrand AV to Q360 Data Mapper</h1>
            <p>Upload a Legrand AV pricing Excel file to automatically map it to the Q360 Load Sheet format</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">ðŸ“„</div>
                <div class="upload-text">Click to upload or drag and drop</div>
                <div class="upload-subtext">Upload your Legrand AV pricing Excel file (.xlsx)</div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx" />
            <div class="file-info" id="fileInfo">
                <strong>File selected:</strong> <span id="fileName"></span>
            </div>
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
        </div>
        
        <div class="process-section">
            <button class="process-btn" id="processBtn" onclick="processFile()" disabled>
                Process File
            </button>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span>Processing your file...</span>
            </div>
        </div>
        
        <div class="result-section" id="resultSection">
            <a class="download-btn" id="downloadBtn" href="#" download="Q360_LoadSheet_LegrandAV_Processed.xlsx">
                Download Processed File
            </a>
            <div class="stats" id="stats"></div>
        </div>
        
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let selectedFile = null;
        let templateWorkbook = null;
        
        // Initialize template on page load
        async function initTemplate() {
            try {
                // Fetch the template from the server or use embedded base64
                const response = await fetch('BLANK_Q360LoadSheet_Masters.xlsx').catch(() => null);
                if (response && response.ok) {
                    const buffer = await response.arrayBuffer();
                    templateWorkbook = XLSX.read(buffer, { type: 'array' });
                }
            } catch (error) {
                console.log('Template will be created dynamically');
            }
        }
        
        // Call init on page load
        initTemplate();
        
        // File input handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.querySelector('.upload-area');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const processBtn = document.getElementById('processBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        
        // Drag and drop handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        function handleFileSelect(file) {
            hideMessages();
            
            if (!file.name.toLowerCase().endsWith('.xlsx')) {
                showError('Please select a valid .xlsx Excel file.');
                return;
            }
            
            selectedFile = file;
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            processBtn.disabled = false;
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }
        
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
        
        function createTemplateStructure() {
            // Create template structure with all 41 columns
            const headers = [
                'MASTERNO', 'ITEMTYPE', 'PARTNO', 'ALTPARTNO', 'DESCRIPTION', 
                'COMMENT', 'MSTKLOC', 'PRODUNITS', 'MANUFACTURER', 'TAXABLE', 
                'USETAXFLAG', 'AUTOPICKFLAG', 'AUTOPRODUCTFLAG', 'WARRANTYFLAG', 
                'RMRTERM', 'SPECIALORDERFLAG', 'MASTERGROUP', 'CLASS', 
                'STANDARDCOST', 'MSRP', 'PRICEA', 'PRICEAFACTOR', 'PRICEB', 
                'PRICEBFACTOR', 'PRICEC', 'PRICECFACTOR', 'PRICED', 'PRICEDFACTOR', 
                'QTYMIN', 'QTYMAX', 'QTYREORDER', 'USER1', 'USER2', 'USER3', 
                'USER4', 'USER5', 'USER6', 'USER7', 'USER8', 'USER9', 'USER10'
            ];
            
            return [headers];
        }
        
        // Function to clean column names (remove non-breaking spaces and extra whitespace)
        function cleanColumnName(name) {
            if (!name) return '';
            // Replace non-breaking spaces and clean up
            return String(name).replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim();
        }
        
        async function processFile() {
            if (!selectedFile) {
                showError('Please select a file first.');
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'flex';
            processBtn.disabled = true;
            hideMessages();
            
            try {
                // Read the uploaded Legrand AV file
                const arrayBuffer = await selectedFile.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // Get the first sheet or find the pricing sheet
                let sourceSheet = null;
                let sheetName = null;
                
                // Try to find a sheet with Legrand AV pricing data
                for (const name of workbook.SheetNames) {
                    const sheet = workbook.Sheets[name];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    // Check if this sheet has the expected columns
                    for (let i = 0; i < Math.min(10, data.length); i++) {
                        const row = data[i];
                        if (row && Array.isArray(row)) {
                            const cleanedRow = row.map(cell => cleanColumnName(cell));
                            const rowStr = cleanedRow.join(',').toLowerCase();
                            if (rowStr.includes('brand') && 
                                rowStr.includes('part number') && 
                                rowStr.includes('description') &&
                                (rowStr.includes('your price') || rowStr.includes('price'))) {
                                sourceSheet = sheet;
                                sheetName = name;
                                break;
                            }
                        }
                    }
                    if (sourceSheet) break;
                }
                
                if (!sourceSheet) {
                    // Use the first sheet as fallback
                    sheetName = workbook.SheetNames[0];
                    sourceSheet = workbook.Sheets[sheetName];
                }
                
                // Convert to JSON to find headers
                const sourceData = XLSX.utils.sheet_to_json(sourceSheet, { header: 1 });
                
                // Find header row
                let headerRowIndex = -1;
                let headers = [];
                
                for (let i = 0; i < Math.min(20, sourceData.length); i++) {
                    const row = sourceData[i];
                    if (row && Array.isArray(row)) {
                        const cleanedRow = row.map(cell => cleanColumnName(cell));
                        const rowStr = cleanedRow.join(',').toLowerCase();
                        if (rowStr.includes('brand') && 
                            rowStr.includes('part number') && 
                            rowStr.includes('description')) {
                            headerRowIndex = i;
                            headers = cleanedRow; // Use cleaned headers
                            break;
                        }
                    }
                }
                
                if (headerRowIndex === -1) {
                    throw new Error('Could not find header row with required columns. Please check the file format.');
                }
                
                // Find column indices (case-insensitive)
                const findColumnIndex = (headers, possibleNames) => {
                    for (let i = 0; i < headers.length; i++) {
                        const header = String(headers[i] || '').toLowerCase().trim();
                        for (const name of possibleNames) {
                            if (header === name.toLowerCase() || header.includes(name.toLowerCase())) {
                                return i;
                            }
                        }
                    }
                    return -1;
                };
                
                // Map columns according to new requirements
                const brandIdx = findColumnIndex(headers, ['brand']);
                const partNumberIdx = findColumnIndex(headers, ['part number', 'part no', 'partno', 'sku']);
                const descriptionIdx = findColumnIndex(headers, ['description', 'desc', 'product description']);
                const yourPriceIdx = findColumnIndex(headers, ['your price', 'dealer price', 'cost']);
                const msrpIdx = findColumnIndex(headers, ['msrp', 'list price', 'retail']);
                
                if (brandIdx === -1) {
                    throw new Error('Could not find "Brand" column in the source file.');
                }
                if (partNumberIdx === -1) {
                    throw new Error('Could not find "Part Number" column in the source file.');
                }
                if (descriptionIdx === -1) {
                    throw new Error('Could not find "Description" column in the source file.');
                }
                if (yourPriceIdx === -1) {
                    throw new Error('Could not find "Your Price" column in the source file.');
                }
                
                // Create new template data
                const templateData = createTemplateStructure();
                
                // Process each data row
                let rowCount = 0;
                let skippedCount = 0;
                const dataRows = sourceData.slice(headerRowIndex + 1);
                
                for (const row of dataRows) {
                    // Skip empty rows
                    if (!row || row.length === 0) continue;
                    
                    const brand = row[brandIdx];
                    const partNumber = row[partNumberIdx];
                    const description = row[descriptionIdx] || '';
                    const yourPrice = row[yourPriceIdx];
                    const msrp = msrpIdx !== -1 ? row[msrpIdx] : '';
                    
                    // Skip if no part number
                    if (!partNumber || String(partNumber).trim() === '') continue;
                    
                    // Process price and check for 0.00
                    const formatPrice = (value) => {
                        if (!value && value !== 0) return '';
                        const str = String(value).replace(/[$,]/g, '').trim();
                        const num = parseFloat(str);
                        return isNaN(num) ? '' : num.toFixed(2);
                    };
                    
                    const formattedYourPrice = formatPrice(yourPrice);
                    
                    // Skip rows where Your Price is 0.00
                    if (formattedYourPrice === '0.00' || formattedYourPrice === '') {
                        skippedCount++;
                        continue;
                    }
                    
                    // Create new row with 41 columns
                    const newRow = new Array(41).fill('');
                    
                    // Map data according to requirements:
                    // Brand â†’ MANUFACTURER
                    // Part Number â†’ MASTERNO and PARTNO
                    // Description â†’ DESCRIPTION
                    // Your Price â†’ STANDARDCOST
                    // MSRP â†’ MSRP
                    
                    newRow[0] = String(partNumber).trim();         // MASTERNO
                    newRow[2] = String(partNumber).trim();         // PARTNO (index 2)
                    newRow[4] = String(description).trim();        // DESCRIPTION
                    newRow[8] = String(brand).trim();              // MANUFACTURER
                    newRow[9] = 'Y';                              // TAXABLE
                    newRow[10] = 'Y';                             // USETAXFLAG
                    newRow[18] = formattedYourPrice;              // STANDARDCOST
                    newRow[19] = formatPrice(msrp);               // MSRP
                    
                    templateData.push(newRow);
                    rowCount++;
                }
                
                if (rowCount === 0) {
                    throw new Error('No valid data rows found in the source file. All rows may have been filtered out due to 0.00 pricing. Please check that the file contains Legrand AV pricing data with valid prices.');
                }
                
                // Create new workbook
                const newWorkbook = XLSX.utils.book_new();
                const newWorksheet = XLSX.utils.aoa_to_sheet(templateData);
                
                // Set column widths for better readability
                const wscols = [
                    { wch: 15 }, // MASTERNO
                    { wch: 10 }, // ITEMTYPE
                    { wch: 15 }, // PARTNO
                    { wch: 15 }, // ALTPARTNO
                    { wch: 40 }, // DESCRIPTION
                    { wch: 20 }, // COMMENT
                    { wch: 10 }, // MSTKLOC
                    { wch: 10 }, // PRODUNITS
                    { wch: 15 }, // MANUFACTURER
                    { wch: 8 },  // TAXABLE
                    { wch: 10 }  // USETAXFLAG
                    // ... rest use default width
                ];
                newWorksheet['!cols'] = wscols;
                
                XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'Material Masters');
                
                // Generate file
                const processedBuffer = XLSX.write(newWorkbook, { 
                    bookType: 'xlsx', 
                    type: 'array'
                });
                
                // Create download link
                const blob = new Blob([processedBuffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                const url = URL.createObjectURL(blob);
                
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.href = url;
                const timestamp = new Date().toISOString().split('T')[0];
                downloadBtn.download = `Q360_LoadSheet_LegrandAV_${timestamp}.xlsx`;
                
                // Show result
                document.getElementById('resultSection').style.display = 'block';
                let statsHtml = `
                    <strong>Processing Complete!</strong><br>
                    Rows processed: ${rowCount}<br>`;
                
                if (skippedCount > 0) {
                    statsHtml += `Rows skipped (0.00 price): ${skippedCount}<br>`;
                }
                
                statsHtml += `Source sheet: ${sheetName}`;
                
                document.getElementById('stats').innerHTML = statsHtml;
                
                let successMsg = `Successfully processed ${rowCount} rows from Legrand AV pricing file.`;
                if (skippedCount > 0) {
                    successMsg += ` (${skippedCount} rows with $0.00 pricing were excluded)`;
                }
                showSuccess(successMsg);
                
            } catch (error) {
                console.error('Processing error:', error);
                showError(`Error processing file: ${error.message}`);
            } finally {
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                processBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
